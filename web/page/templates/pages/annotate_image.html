{% extends 'base.html' %}

{% block content %}
<h1>Annotate Existing Images</h1>

<!-- Filter -->
<form method="get" class="form-inline mb-3">
  <label class="mr-2">Klasse</label>
  <select name="cls" class="form-control mr-3">
    <option value="">Alle</option>
    {% for name in class_names %}
      <option value="{{ name }}" {% if selected_class == name %}selected{% endif %}>{{ name }}</option>
    {% endfor %}
  </select>

  <label class="mr-2">Annotierung</label>
  <select name="annotated" class="form-control mr-3">
    <option value="all" {% if annotated_filter == 'all' %}selected{% endif %}>Alle</option>
    <option value="yes" {% if annotated_filter == 'yes' %}selected{% endif %}>Annotiert</option>
    <option value="no"  {% if annotated_filter == 'no'  %}selected{% endif %}>Nicht annotiert</option>
  </select>

  <button type="submit" class="btn btn-primary mr-2">Filtern</button>
  {% if selected_class or annotated_filter != 'all' %}
    <a href="?" class="btn btn-link">Zur√ºcksetzen</a>
  {% endif %}
</form>

<p class="text-muted">{{ images|length }} Bild(er) gefunden.</p>

{% if images %}
  <ul>
    {% for img in images %}
    <li style="margin-bottom: 10px;">
      <strong>{{ img.filename }}</strong>
      ({{ img.subset }}{% if img.inferred_class %} ‚Ä¢ {{ img.inferred_class }}{% endif %})
      {% if img.is_annotated %}
        <span class="text-success ml-2">‚úÖ Annotiert</span>
      {% else %}
        <span class="text-muted ml-2">üü• Nicht annotiert</span>
      {% endif %}
      <br>
      <img src="/{{ img.path }}" alt="{{ img.filename }}" width="200"><br>
      <button type="button" class="btn btn-sm btn-primary"
              onclick="startAnnotation('{{ img.path }}', '{{ img.subset }}')">
        Annotate
      </button>
    </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No images found in dataset folders.</p>
{% endif %}

<!-- Bootstrap & jQuery -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Sichere √úbergabe der Klassenliste als JSON -->
{{ class_names|json_script:"class-names" }}

<script>
/* IIFE-Start */
(function () {
  // ---- Klassen aus JSON ziehen (kein Template-Code im JS mehr) ----
  const CLASS_NAMES = JSON.parse(document.getElementById('class-names').textContent);

  // ---- State ----
  let modal, canvas, ctx, form, closeBtn, saveBtn;
  let classPicker, boxesList;
  let boxes = []; // {x_min,y_min,x_max,y_max,class_id}
  let img = new Image();
  let isDrawing = false;
  let startX = 0, startY = 0;
  let activeBoxIndex = null;
  let listenersBound = false;
  let currentClassId = 0;

  function colorForClass(id) {
    const colors = ['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#84cc16','#f97316','#06b6d4'];
    return colors[id % colors.length];
  }

  // ---- Modal & DOM ----
  function ensureModalExists() {
    modal = document.getElementById('annotationModal');
    if (modal) return;

    const html = `
      <div id="annotationModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#fff;width:min(96vw,1200px);max-height:92vh;overflow:auto;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px;">
          <div class="d-flex align-items-center justify-content-between">
            <h3 class="m-0">Bild annotieren</h3>
            <button id="annotClose" type="button" class="btn btn-light btn-sm">Schlie√üen</button>
          </div>

          <div class="row mt-2">
            <div class="col-md-8">
              <div class="mb-2 d-flex align-items-center" style="gap:10px;">
                <label class="mb-0">Klasse zum Zeichnen:</label>
                <select id="classPicker" class="form-control form-control-sm" style="width:220px;"></select>
                <small class="text-muted">Erst Klasse w√§hlen, dann auf dem Bild ziehen.</small>
              </div>
              <canvas id="canvas" width="800" height="600" style="max-width:100%;border:1px solid #ddd;border-radius:10px;cursor:crosshair;"></canvas>
            </div>

            <div class="col-md-4">
              <h6>Boxen im Bild</h6>
              <div id="boxesList" class="border rounded p-2" style="max-height:60vh;overflow:auto;"></div>
              <form id="annotationForm" class="mt-3">
                <input type="hidden" name="subset" id="subset">
                <input type="hidden" name="filename" id="filename">
                <button id="annotSave" type="submit" class="btn btn-primary btn-block">Speichern</button>
              </form>
              <small class="text-muted d-block mt-2">Box anklicken = markieren ‚Ä¢ Doppelklick = l√∂schen</small>
            </div>
          </div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
  }
  function showModal(){ ensureModalExists(); document.getElementById('annotationModal').style.display='flex'; }
  function hideModal(){ ensureModalExists(); document.getElementById('annotationModal').style.display='none'; }

  function ensureDomRefs() {
    ensureModalExists();
    canvas = document.getElementById('canvas') || canvas;
    form = document.getElementById('annotationForm') || form;
    closeBtn = document.getElementById('annotClose') || closeBtn;
    saveBtn = document.getElementById('annotSave') || saveBtn;
    classPicker = document.getElementById('classPicker') || classPicker;
    boxesList = document.getElementById('boxesList') || boxesList;
    if (!ctx && canvas) ctx = canvas.getContext('2d');
    return !!(canvas && form && closeBtn && saveBtn && classPicker && boxesList && ctx);
  }

  function populateClassPicker() {
    classPicker.innerHTML = '';
    CLASS_NAMES.forEach((name, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${idx} ‚Äî ${name}`;
      classPicker.appendChild(opt);
    });
    classPicker.value = currentClassId;
  }

  // ---- Helpers ----
  function getMousePos(e) {
    const r = canvas.getBoundingClientRect();
    const sx = canvas.width / r.width, sy = canvas.height / r.height;
    return { x: (e.clientX - r.left) * sx, y: (e.clientY - r.top) * sy };
  }

  function drawAll() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    boxes.forEach((b,i)=>{
      ctx.strokeStyle = colorForClass(+b.class_id);
      ctx.lineWidth = (i===activeBoxIndex)?3:2;
      ctx.setLineDash([]);
      ctx.strokeRect(b.x_min,b.y_min,b.x_max-b.x_min,b.y_max-b.y_min);
      const label = `${b.class_id} ${CLASS_NAMES[b.class_id]||''}`;
      ctx.font = '12px sans-serif';
      ctx.fillStyle='rgba(0,0,0,.6)';
      const tw = ctx.measureText(label).width+8;
      ctx.fillRect(b.x_min, b.y_min-16, tw, 16);
      ctx.fillStyle='#fff';
      ctx.fillText(label, b.x_min+4, b.y_min-4);
    });
  }

  function refreshList(){
    boxesList.innerHTML='';
    boxes.forEach((b,i)=>{
      const row=document.createElement('div');
      row.className='d-flex align-items-center mb-2';
      row.style.gap='6px';

      const badge=document.createElement('span');
      badge.className='badge'; badge.style.background=colorForClass(+b.class_id);
      badge.textContent=i+1;

      const sel=document.createElement('select');
      sel.className='form-control form-control-sm'; sel.style.width='100%';
      CLASS_NAMES.forEach((name,idx)=>{
        const opt=document.createElement('option'); opt.value=idx; opt.textContent=`${idx} ‚Äî ${name}`;
        if(+b.class_id===idx) opt.selected=true;
        sel.appendChild(opt);
      });
      sel.addEventListener('change',()=>{ b.class_id=+sel.value; drawAll(); });

      const del=document.createElement('button');
      del.type='button'; del.className='btn btn-sm btn-outline-danger'; del.textContent='L√∂schen';
      del.addEventListener('click',()=>{ boxes.splice(i,1); activeBoxIndex=null; refreshList(); drawAll(); });

      row.appendChild(badge); row.appendChild(sel); row.appendChild(del);
      boxesList.appendChild(row);
    });
  }

  function loadExistingLabels(imagePath, subset, filename){
    const labelPath = `/media/labels/${subset}/${filename.replace(/\.[^/.]+$/, "")}.txt?nocache=${Date.now()}`;
    fetch(labelPath)
      .then(r => { if(!r.ok) throw 0; return r.text(); })
      .then(text=>{
        boxes=[];
        text.trim().split(/\r?\n/).filter(Boolean).forEach(line=>{
          const p=line.trim().split(/\s+/).map(Number);
          const [cid,x,y,w,h]=p;
          const cx=x*img.originalWidth, cy=y*img.originalHeight;
          const bw=w*img.originalWidth, bh=h*img.originalHeight;
          boxes.push({
            class_id:+cid,
            x_min:(cx-bw/2)*img.scale,
            y_min:(cy-bh/2)*img.scale,
            x_max:(cx+bw/2)*img.scale,
            y_max:(cy+bh/2)*img.scale
          });
        });
        refreshList(); drawAll();
      })
      .catch(()=>{ /* keine Labels vorhanden */ });
  }

  function getCsrfToken(){
    const m=document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
    return m?decodeURIComponent(m[1]):'';
  }

  function bindListeners(){
    if(listenersBound || !ensureDomRefs()) return;

    closeBtn.addEventListener('click', hideModal);
    classPicker.addEventListener('change',()=>{ currentClassId=+classPicker.value; });

    canvas.addEventListener('mousedown',e=>{
      const {x,y}=getMousePos(e);
      activeBoxIndex=boxes.findIndex(b=>x>=b.x_min&&x<=b.x_max&&y>=b.y_min&&y<=b.y_max);
      if(activeBoxIndex!==-1){ drawAll(); return; }
      startX=x; startY=y; isDrawing=true;
    });

    canvas.addEventListener('mousemove',e=>{
      if(!isDrawing) return;
      const {x:cx,y:cy}=getMousePos(e);
      drawAll();
      ctx.strokeStyle=colorForClass(currentClassId);
      ctx.lineWidth=1; ctx.setLineDash([6]);
      ctx.strokeRect(Math.min(startX,cx),Math.min(startY,cy),Math.abs(cx-startX),Math.abs(cy-startY));
      ctx.setLineDash([]);
    });

    canvas.addEventListener('mouseup',e=>{
      if(!isDrawing) return; isDrawing=false;
      const {x:ex,y:ey}=getMousePos(e);
      if(Math.abs(ex-startX)<3||Math.abs(ey-startY)<3){ drawAll(); return; }
      boxes.push({ class_id:currentClassId, x_min:Math.min(startX,ex), y_min:Math.min(startY,ey), x_max:Math.max(startX,ex), y_max:Math.max(startY,ey) });
      activeBoxIndex=boxes.length-1; refreshList(); drawAll();
    });

    canvas.addEventListener('dblclick',e=>{
      const {x,y}=getMousePos(e);
      const idx=boxes.findIndex(b=>x>=b.x_min&&x<=b.x_max&&y>=b.y_min&&y<=b.y_max);
      if(idx!==-1){ boxes.splice(idx,1); activeBoxIndex=null; refreshList(); drawAll(); }
    });

    form.addEventListener('submit',e=>{
      e.preventDefault();
      const yoloLines=boxes.map(b=>{
        const xc=((b.x_min+b.x_max)/2)/img.scale/img.originalWidth;
        const yc=((b.y_min+b.y_max)/2)/img.scale/img.originalHeight;
        const w=(b.x_max-b.x_min)/img.scale/img.originalWidth;
        const h=(b.y_max-b.y_min)/img.scale/img.originalHeight;
        return `${b.class_id} ${xc.toFixed(6)} ${yc.toFixed(6)} ${w.toFixed(6)} ${h.toFixed(6)}`;
      });
      const fd=new FormData(form);
      fd.append('boxes', JSON.stringify(yoloLines));

      fetch("{% url 'upload_annotated_image_existing' %}", {
        method:'POST',
        headers:{ 'X-CSRFToken': getCsrfToken() },
        body: fd
      })
      .then(r=>r.ok?r.json():Promise.reject(r))
      .then(data=>{ alert((data&&data.message)||'Gespeichert!'); hideModal(); location.reload(); })
      .catch(()=>alert('Fehler beim Speichern.'));
    });

    listenersBound=true;
  }

  // ---- Public API ----
  window.startAnnotation = function(imagePath, subset){
    if(!ensureDomRefs()){ alert('Canvas/Form not found on page.'); return; }
    populateClassPicker(); bindListeners();

    boxes=[]; activeBoxIndex=null;
    const filename=imagePath.split('/').pop();
    document.getElementById('subset').value=subset;
    document.getElementById('filename').value=filename;

    img.onload=function(){
      const maxW=Math.min(window.innerWidth*0.9,1200);
      const scale=Math.min(1, maxW/img.width);
      canvas.width=Math.round(img.width*scale);
      canvas.height=Math.round(img.height*scale);
      img.originalWidth=img.width; img.originalHeight=img.height; img.scale=scale;
      drawAll();
      loadExistingLabels(imagePath, subset, filename);
      showModal();
    };
    img.onerror=function(){ alert('Bild konnte nicht geladen werden.'); };
    img.src='/' + imagePath.replace(/^\/+/, '');
  };
})(); /* IIFE-Ende */
</script>

{% endblock %}
