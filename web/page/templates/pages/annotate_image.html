{% extends 'base.html' %}

{% block content %}
<h1>Annotate Existing Images</h1>

<!-- Filterleiste -->
<form method="get" class="form-inline mb-3">
  <label class="mr-2">Klasse</label>
  <select name="cls" class="form-control mr-3">
    <option value="">Alle</option>
    {% for name in class_names %}
      <option value="{{ name }}" {% if selected_class == name %}selected{% endif %}>{{ name }}</option>
    {% endfor %}
  </select>

  <label class="mr-2">Annotierung</label>
  <select name="annotated" class="form-control mr-3">
    <option value="all" {% if annotated_filter == 'all' %}selected{% endif %}>Alle</option>
    <option value="yes" {% if annotated_filter == 'yes' %}selected{% endif %}>Annotiert</option>
    <option value="no"  {% if annotated_filter == 'no'  %}selected{% endif %}>Nicht annotiert</option>
  </select>

  <button type="submit" class="btn btn-primary mr-2">Filtern</button>
  {% if selected_class or annotated_filter != 'all' %}
    <a href="?" class="btn btn-link">Zur√ºcksetzen</a>
  {% endif %}
</form>

<p class="text-muted">{{ images|length }} Bild(er) gefunden.</p>

{% if images %}
  <ul>
    {% for img in images %}
    <li style="margin-bottom: 10px;">
        <strong>{{ img.filename }}</strong>
        ({{ img.subset }}
        {% if img.inferred_class %} ‚Ä¢ {{ img.inferred_class }}{% endif %})
        {% if img.is_annotated %}
          <span class="text-success ml-2">‚úÖ Annotiert</span>
        {% else %}
          <span class="text-muted ml-2">üü• Nicht annotiert</span>
        {% endif %}
        <br>
        <img src="/{{ img.path }}" alt="{{ img.filename }}" width="200"><br>
        <button type="button" class="btn btn-sm btn-primary"
                onclick="startAnnotation('{{ img.path }}', '{{ img.subset }}')">
          Annotate
        </button>
    </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No images found in dataset folders.</p>
{% endif %}

<!-- Load Bootstrap & jQuery -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function () {
  // ---- State ----
  let modal, canvas, ctx, form, closeBtn, saveBtn;
  let boxes = [];
  let img = new Image();
  let isDrawing = false;
  let startX = 0, startY = 0;
  let activeBoxIndex = null;
  let listenersBound = false;

  // ---- Utilities ----
  function ensureModalExists() {
    modal = document.getElementById('annotationModal');
    if (modal) return;

    // Minimaler, eigenst√§ndiger Modal mit Canvas + Formular
    const html = `
      <div id="annotationModal" style="
          position: fixed; inset: 0; background: rgba(0,0,0,0.6);
          display:none; align-items:center; justify-content:center; z-index: 9999;">
        <div style="
            background:#fff; width:min(96vw,1000px); max-height:92vh; overflow:auto;
            border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.3); padding:16px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:6px 0;">Bild annotieren</h3>
            <button id="annotClose" type="button" aria-label="Schlie√üen"
                    style="border:none;background:#eee;border-radius:10px;padding:8px 12px;cursor:pointer">Schlie√üen</button>
          </div>

          <div style="display:flex; flex-direction:column; gap:12px;">
            <canvas id="canvas" width="800" height="600" style="max-width:100%; border:1px solid #ddd; border-radius:10px;"></canvas>

            <form id="annotationForm" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <input type="hidden" name="subset" id="subset">
              <input type="hidden" name="filename" id="filename">
              <!-- Falls du eine Klassen-Auswahl brauchst, kannst du hier ein <select> erg√§nzen -->
              <button id="annotSave" type="submit" style="padding:8px 14px; border-radius:10px; border:none; background:#2563eb; color:#fff; cursor:pointer;">
                Speichern
              </button>
            </form>

            <small style="color:#666">Tipp: Ziehe mit der Maus, um eine Box zu erstellen. Box anklicken, um sie zu l√∂schen.</small>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
  }

  function showModal() { ensureModalExists(); document.getElementById('annotationModal').style.display = 'flex'; }
  function hideModal() { ensureModalExists(); document.getElementById('annotationModal').style.display = 'none'; }

  function ensureDomRefs() {
    ensureModalExists();
    canvas = document.getElementById('canvas') || canvas;
    form   = document.getElementById('annotationForm') || form;
    closeBtn = document.getElementById('annotClose') || closeBtn;
    saveBtn  = document.getElementById('annotSave') || saveBtn;

    if (!canvas) { console.error('No #canvas element in DOM'); return false; }
    if (!form)   { console.error('No #annotationForm element in DOM'); return false; }
    if (!ctx) {
      ctx = canvas.getContext('2d');
      if (!ctx) { console.error('Could not get 2D context from canvas'); return false; }
    }
    return true;
  }

  function getMousePos(event) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
      x: (event.clientX - rect.left) * scaleX,
      y: (event.clientY - rect.top) * scaleY
    };
  }

  function drawAllBoxes() {
    if (!ensureDomRefs()) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    boxes.forEach((box, i) => {
      ctx.strokeStyle = (i === activeBoxIndex) ? 'blue' : 'red';
      ctx.lineWidth = 2;
      ctx.setLineDash([]);
      ctx.strokeRect(
        box.x_min,
        box.y_min,
        box.x_max - box.x_min,
        box.y_max - box.y_min
      );
    });
  }

  function loadExistingLabels(imagePath, subset, filename) {
    const labelPath = `/media/labels/${subset}/${filename.replace(/\.[^/.]+$/, "")}.txt?nocache=${Date.now()}`;
    fetch(labelPath)
      .then(res => { if (!res.ok) throw new Error('No labels'); return res.text(); })
      .then(text => {
        const lines = text.trim().split(/\r?\n/).filter(Boolean);
        boxes = [];
        lines.forEach(line => {
          const parts = line.trim().split(/\s+/).map(Number);
          // Erwartetes Format: class_id x_center y_center width height (YOLO, normiert 0..1)
          const class_id = parts[0]; const x = parts[1], y = parts[2], w = parts[3], h = parts[4];
          const cx = x * img.originalWidth;
          const cy = y * img.originalHeight;
          const bw = w * img.originalWidth;
          const bh = h * img.originalHeight;
          boxes.push({
            class_id: String(class_id),
            x_min: (cx - bw/2) * img.scale,
            y_min: (cy - bh/2) * img.scale,
            x_max: (cx + bw/2) * img.scale,
            y_max: (cy + bh/2) * img.scale
          });
        });
        drawAllBoxes();
      })
      .catch(() => { /* keine vorhandenen Labels */ });
  }

  // CSRF f√ºr Django (falls n√∂tig)
  function getCsrfToken() {
    const m = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }

  function bindListenersOnce() {
    if (listenersBound || !ensureDomRefs()) return;

    // Close
    closeBtn.addEventListener('click', hideModal);

    // Zeichnen
    canvas.addEventListener('mousedown', function (e) {
      const { x, y } = getMousePos(e);

      // Klick auf vorhandene Box => l√∂schen
      activeBoxIndex = boxes.findIndex(box =>
        x >= box.x_min && x <= box.x_max &&
        y >= box.y_min && y <= box.y_max
      );
      if (activeBoxIndex !== -1) {
        if (confirm('Diese Box l√∂schen?')) {
          boxes.splice(activeBoxIndex, 1);
          activeBoxIndex = null;
          drawAllBoxes();
        }
        return;
      }

      startX = x; startY = y; isDrawing = true;
    });

    canvas.addEventListener('mousemove', function (e) {
      if (!isDrawing) return;
      const { x: currentX, y: currentY } = getMousePos(e);
      drawAllBoxes();
      ctx.strokeStyle = 'green';
      ctx.lineWidth = 1;
      ctx.setLineDash([6]);
      ctx.strokeRect(
        Math.min(startX, currentX),
        Math.min(startY, currentY),
        Math.abs(currentX - startX),
        Math.abs(currentY - startY)
      );
      ctx.setLineDash([]);
    });

    canvas.addEventListener('mouseup', function (e) {
      if (!isDrawing) return;
      isDrawing = false;
      const { x: endX, y: endY } = getMousePos(e);
      // Ignorieren, wenn Box extrem klein
      if (Math.abs(endX - startX) < 3 || Math.abs(endY - startY) < 3) { drawAllBoxes(); return; }
      boxes.push({
        x_min: Math.min(startX, endX),
        y_min: Math.min(startY, endY),
        x_max: Math.max(startX, endX),
        y_max: Math.max(startY, endY)
      });
      drawAllBoxes();
    });

    // Speichern
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      // In YOLO (normiert) umrechnen
      const yoloBoxes = boxes.map(box => {
        const x_center = ((box.x_min + box.x_max) / 2) / img.scale / img.originalWidth;
        const y_center = ((box.y_min + box.y_max) / 2) / img.scale / img.originalHeight;
        const w = (box.x_max - box.x_min) / img.scale / img.originalWidth;
        const h = (box.y_max - box.y_min) / img.scale / img.originalHeight;
        // Ohne Klassen-ID (oder nimm "0", wenn deine Pipeline es erwartet)
        return `0 ${x_center.toFixed(6)} ${y_center.toFixed(6)} ${w.toFixed(6)} ${h.toFixed(6)}`;
      });

      const fd = new FormData(form);
      fd.append('boxes', JSON.stringify(yoloBoxes));

      fetch("{% url 'upload_annotated_image_existing' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken() },
        body: fd
      })
        .then(r => r.ok ? r.json() : Promise.reject(r))
        .then(data => {
          alert((data && data.message) || 'Gespeichert!');
          hideModal();
          location.reload();
        })
        .catch(() => alert('Fehler beim Speichern.'));
    });

    listenersBound = true;
  }

  // ---- Public API ----
  window.startAnnotation = function (imagePath, subset) {
    if (!ensureDomRefs()) {
      alert('Canvas/Form not found on page.');
      return;
    }

    bindListenersOnce();

    boxes = [];
    activeBoxIndex = null;

    const filename = imagePath.split('/').pop();
    document.getElementById('subset').value = subset;
    document.getElementById('filename').value = filename;

    img.onload = function () {
      // auf verf√ºgbare Breite skalieren
      const maxW = Math.min(window.innerWidth * 0.9, 1000);
      const scale = Math.min(1, maxW / img.width);

      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);

      img.originalWidth = img.width;
      img.originalHeight = img.height;
      img.scale = scale;

      drawAllBoxes();

      // vorhandene Labels nachladen
      loadExistingLabels(imagePath, subset, filename);

      showModal();
    };

    img.onerror = function () {
      alert('Bild konnte nicht geladen werden.');
    };

    img.src = '/' + imagePath.replace(/^\/+/, '');
  };

})();
</script>


{% endblock %}
