{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>Zutat hinzufügen</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-group">
      <label for="id_img">Bild</label>
      <input type="file" class="form-control-file" accept="image/*" capture="camera" name="img" id="id_img" required>
    </div>
    <div class="form-group">
      <label for="id_description">Beschreibung</label>
      <input type="text" name="description" class="form-control" id="id_description" required>
    </div>
    <div class="form-group">
      <label for="id_mhd">Mindesthaltbarkeitsdatum</label>
      <input type="date" class="form-control" name="mhd" id="id_mhd" required>
    </div>
    <div class="form-group">
      <label for="id_quantity">Anzahl</label>
      <input type="number" class="form-control" name="quantity" id="id_quantity" min="1" max="100" value="1" required>
    </div>
    <div class="form-group">
      <label for="id_weight">Gewicht</label>
      <input type="number" class="form-control" name="weight" id="id_weight" min="0" max="10000" value="0">
    </div>
    <div class="form-group">
      <label>Tags</label>
      <input type="text" data-role="tagsinput" class="form-control tagsinput" name="tags">
      <select id="tags" name="tags" multiple class="form-control">
        {% for tag in used_tags %}
          <option value="{{ tag.name }}">{{ tag.name }}</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="btn btn-primary btn-block">Zutat hinzufügen</button>
  </form>
</div>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#id_img').change(function() {
                var imageData = new FormData();
                var imageFile = $('#id_img')[0].files[0];
                imageData.append('image', imageFile);
                
                var url = '/image_classification/';
                var csrftoken = getCookie('csrftoken');

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    body: imageData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Image was classified');
                        document.getElementById('id_description').value = data.image_class;
                    } else {
                        console.log('Error classify your image');
                    }
                })
                .catch(error => {
                    console.log('Error while sending Ajax request:', error);
                });
            });
        });

        // Funktion zum Abrufen des CSRF-Tokens aus den Cookies
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Überprüfe, ob der Cookie den Namen 'csrftoken' hat
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
{% endblock %}
